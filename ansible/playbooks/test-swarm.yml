---
- name: Test Docker Swarm Cluster
  hosts: swarm_manager
  become: true
  tasks:
    - name: Check Swarm status
      command: docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: swarm_state
      changed_when: false
      failed_when: swarm_state.stdout != "active"

    - name: Get number of nodes
      command: docker node ls --format "{{ '{{' }}.Hostname{{ '}}' }}"
      register: node_count
      changed_when: false

    - name: Verify minimum nodes
      assert:
        that:
          - node_count.stdout_lines | length >= 2
        fail_msg: "Cluster has {{ node_count.stdout_lines | length }} nodes, expected at least 2"
        success_msg: "Cluster has {{ node_count.stdout_lines | length }} nodes"

    - name: Check all nodes are ready
      command: docker node ls --format "{{ '{{' }}.Status{{ '}}' }}"
      register: node_status
      changed_when: false
      failed_when: "'Down' in node_status.stdout"

    - name: Get deployed stacks
      command: docker stack ls --format "{{ '{{' }}.Name{{ '}}' }}"
      register: deployed_stacks
      changed_when: false

    - name: Display deployed stacks
      debug:
        msg: "Deployed stacks: {{ deployed_stacks.stdout_lines }}"

    - name: Check if mystack is deployed
      assert:
        that:
          - "'mystack' in deployed_stacks.stdout"
        fail_msg: "Stack 'mystack' is not deployed"
        success_msg: "Stack 'mystack' is deployed"
      when: deployed_stacks.stdout_lines | length > 0

    - name: Get services in mystack
      command: docker service ls --filter label=com.docker.stack.namespace=mystack --format "{{ '{{' }}.Name{{ '}}' }} {{ '{{' }}.Replicas{{ '}}' }}"
      register: stack_services
      changed_when: false
      when: "'mystack' in deployed_stacks.stdout"

    - name: Display service status
      debug:
        msg: "{{ stack_services.stdout_lines }}"
      when: stack_services is defined and stack_services.stdout_lines is defined

    - name: Check for unhealthy services
      shell: |
        docker service ls --filter label=com.docker.stack.namespace=mystack --format "{{ '{{' }}.Replicas{{ '}}' }}" | \
        awk -F'/' '{if ($1 != $2) print "unhealthy"}'
      register: unhealthy_check
      changed_when: false
      failed_when: unhealthy_check.stdout != ""
      when: "'mystack' in deployed_stacks.stdout"

    - name: Test web service endpoint
      uri:
        url: "http://{{ ansible_host }}/health"
        method: GET
        return_content: yes
        status_code: 200
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200
      when: "'mystack' in deployed_stacks.stdout"

    - name: Display health check result
      debug:
        msg: "Health check passed: {{ health_check.content }}"
      when:
        - health_check is defined
        - health_check.content is defined

    - name: Check Docker daemon metrics
      uri:
        url: "http://{{ ansible_host }}:9323/metrics"
        method: GET
        status_code: 200
      register: metrics_check
      failed_when: false
      changed_when: false

    - name: Check Prometheus accessibility
      uri:
        url: "http://{{ ansible_host }}:9090/-/healthy"
        method: GET
        status_code: 200
      register: prometheus_check
      retries: 3
      delay: 5
      failed_when: false
      when: "'mystack' in deployed_stacks.stdout"

    - name: Check Grafana accessibility
      uri:
        url: "http://{{ ansible_host }}:3000/api/health"
        method: GET
        status_code: 200
      register: grafana_check
      retries: 3
      delay: 5
      failed_when: false
      when: "'mystack' in deployed_stacks.stdout"

    - name: Check Visualizer accessibility
      uri:
        url: "http://{{ ansible_host }}:8080"
        method: GET
        status_code: 200
      register: visualizer_check
      retries: 3
      delay: 5
      failed_when: false
      when: "'mystack' in deployed_stacks.stdout"

    - name: Generate test summary
      debug:
        msg:
          - "=== Swarm Cluster Test Summary ==="
          - "Swarm Status: {{ swarm_state.stdout }}"
          - "Total Nodes: {{ node_count.stdout_lines | length }}"
          - "Deployed Stacks: {{ deployed_stacks.stdout_lines | length }}"
          - "Prometheus: {{ 'Healthy' if prometheus_check.status == 200 else 'Not Available' }}"
          - "Grafana: {{ 'Healthy' if grafana_check.status == 200 else 'Not Available' }}"
          - "Visualizer: {{ 'Healthy' if visualizer_check.status == 200 else 'Not Available' }}"
