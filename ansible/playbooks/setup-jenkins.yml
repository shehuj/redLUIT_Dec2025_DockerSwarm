---
# ========================================
# Deploy Jenkins CI/CD Stack
# ========================================
- name: Deploy Jenkins CI/CD Stack
  hosts: swarm_manager
  become: true
  gather_facts: true

  vars:
    jenkins_home: /var/jenkins_home
    jenkins_port: 8081
    jenkins_agent_port: 50000

  tasks:
    # ========================================
    # Basic Swarm Check
    # ========================================
    - name: Verify Docker Swarm is active
      ansible.builtin.command: docker info --format '{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}'
      register: swarm_state
      changed_when: false
      failed_when: swarm_state.stdout != 'active'

    - name: Display Swarm status
      ansible.builtin.debug:
        msg: "Docker Swarm is active. Proceeding with Jenkins deployment..."

    # ========================================
    # Environment Cleanup
    # ========================================
    - name: Check for existing Jenkins services
      ansible.builtin.command: docker service ls --filter "name=jenkins" --format "{{ '{{' }}.Name{{ '}}' }}"
      register: existing_jenkins
      changed_when: false
      failed_when: false

    - name: Display existing Jenkins services
      ansible.builtin.debug:
        msg: "Found existing Jenkins services: {{ existing_jenkins.stdout_lines }}"
      when: existing_jenkins.stdout_lines | length > 0

    - name: Remove existing Jenkins stack
      ansible.builtin.command: docker stack rm jenkins
      when: existing_jenkins.stdout_lines | length > 0
      register: stack_removed
      failed_when: false

    - name: Wait for Jenkins stack removal to complete
      ansible.builtin.pause:
        seconds: 15
      when: stack_removed.changed

    - name: Prune unused volumes
      ansible.builtin.command: docker volume prune -f
      register: volume_prune
      changed_when: "'deleted' in volume_prune.stdout"

    # ========================================
    # Setup Jenkins Directories and Configs
    # ========================================
    - name: Create Jenkins deployment directory
      ansible.builtin.file:
        path: /opt/jenkins
        state: directory
        mode: '0755'

    - name: Create Jenkins data directory
      ansible.builtin.file:
        path: "{{ jenkins_home }}"
        state: directory
        mode: '0755'
        owner: 1000
        group: 1000

    - name: Copy Jenkins stack file
      ansible.builtin.copy:
        src: "../../jenkins-stack.yml"
        dest: /opt/jenkins/docker-compose.yml
        mode: '0644'

    # ========================================
    # Deploy Jenkins Stack
    # ========================================
    - name: Deploy Jenkins stack to swarm
      ansible.builtin.command:
        cmd: docker stack deploy -c docker-compose.yml jenkins
        chdir: /opt/jenkins
      register: jenkins_deploy
      changed_when: "'Creating service' in jenkins_deploy.stdout or 'Updating service' in jenkins_deploy.stdout"

    - name: Wait for Jenkins service to start
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for Jenkins to initialize..."

    - name: Get Jenkins service status
      ansible.builtin.command: docker service ls --filter "name=jenkins" --format "{{ '{{' }}.Name{{ '}}' }} {{ '{{' }}.Replicas{{ '}}' }}"
      register: jenkins_status
      changed_when: false

    - name: Display Jenkins service status
      ansible.builtin.debug:
        msg: "{{ jenkins_status.stdout_lines }}"

    # ========================================
    # Validate Jenkins Deployment
    # ========================================
    - name: Wait for Jenkins container to be running
      ansible.builtin.shell: docker ps --filter "name=jenkins_jenkins" --format "{{ '{{' }}.Status{{ '}}' }}" | grep -i "up" || echo "not running"
      register: container_status
      until: "'Up' in container_status.stdout"
      retries: 60
      delay: 5
      changed_when: false
      failed_when: false

    - name: Display container status
      ansible.builtin.debug:
        msg: "Jenkins container status: {{ container_status.stdout }}"

    - name: Get Jenkins service logs for diagnostics
      ansible.builtin.command: docker service logs --tail 50 jenkins_jenkins
      register: jenkins_logs
      changed_when: false
      failed_when: false

    - name: Display recent Jenkins logs
      ansible.builtin.debug:
        msg: "{{ jenkins_logs.stdout_lines[-10:] if jenkins_logs.stdout_lines | length > 0 else 'No logs available' }}"

    - name: Check if Jenkins port is listening
      ansible.builtin.wait_for:
        port: "{{ jenkins_port }}"
        host: localhost
        timeout: 300
        delay: 10
      register: port_check
      failed_when: false

    - name: Wait for Jenkins to be ready
      ansible.builtin.uri:
        url: "http://localhost:{{ jenkins_port }}/login"
        status_code: 200
        timeout: 10
      register: jenkins_ready
      until: jenkins_ready.status == 200
      retries: 60
      delay: 10
      failed_when: false

    - name: Display Jenkins readiness status
      ansible.builtin.debug:
        msg: >-
          Jenkins status: {{ 'Ready' if jenkins_ready.status == 200 else
          'Not accessible (Status: ' + (jenkins_ready.status | string) + ')' }}

    - name: Get Jenkins initial admin password
      ansible.builtin.command: docker exec $(docker ps -q -f name=jenkins_jenkins) cat /var/jenkins_home/secrets/initialAdminPassword
      register: jenkins_password
      changed_when: false
      failed_when: false
      when: jenkins_ready.status == 200

    - name: Display detailed error if Jenkins is not accessible
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "   Jenkins Deployment Issue Detected"
          - "========================================="
          - "Container Status: {{ container_status.stdout }}"
          - "Port Check: {{ 'Port listening' if port_check is succeeded else 'Port not listening' }}"
          - "HTTP Status: {{ jenkins_ready.status | default('Connection failed') }}"
          - ""
          - "Recent logs (last 10 lines):"
          - "{{ jenkins_logs.stdout_lines[-10:] | default(['No logs available']) | join('\n') }}"
          - ""
          - "To debug further, run:"
          - "  docker service ps jenkins_jenkins --no-trunc"
          - "  docker service logs jenkins_jenkins"
          - "========================================="
      when: jenkins_ready.status != 200

    # ========================================
    # Validate Swarm-wide Deployment
    # ========================================
    - name: Get Jenkins service placement
      ansible.builtin.command: docker service ps jenkins_jenkins --format "{{ '{{' }}.Node{{ '}}' }} {{ '{{' }}.CurrentState{{ '}}' }}"
      register: jenkins_placement
      changed_when: false

    - name: Display Jenkins placement across cluster
      ansible.builtin.debug:
        msg: "{{ jenkins_placement.stdout_lines }}"

    - name: Verify Jenkins service is running
      ansible.builtin.command:
        cmd: docker service inspect jenkins_jenkins --format "{{ '{{' }}.Spec.Name{{ '}}' }}"
      register: jenkins_inspect
      changed_when: false

    # ========================================
    # Display Access Information
    # ========================================
    - name: Display Jenkins access information
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "   ðŸš€ Jenkins CI/CD Deployed Successfully!"
          - "========================================="
          - ""
          - "Access Information:"
          - "  Jenkins URL: http://{{ ansible_facts.default_ipv4.address }}:{{ jenkins_port }}"
          - "  Agent Port: {{ jenkins_agent_port }}"
          - ""
          - "Initial Admin Password:"
          - >-
            {{ jenkins_password.stdout if jenkins_password.rc == 0 else
            'Run: docker exec $(docker ps -q -f name=jenkins) cat /var/jenkins_home/secrets/initialAdminPassword' }}
          - ""
          - "Service Status:"
          - "  {{ jenkins_inspect.stdout }}"
          - ""
          - "Deployed on Node:"
          - "  {{ jenkins_placement.stdout_lines[0] if jenkins_placement.stdout_lines | length > 0 else 'Unknown' }}"
          - ""
          - "Next Steps:"
          - "  1. Access Jenkins at the URL above"
          - "  2. Use the initial admin password to unlock Jenkins"
          - "  3. Install suggested plugins"
          - "  4. Create your first admin user"
          - "  5. Configure Jenkins for your CI/CD pipelines"
          - ""
          - "========================================="
