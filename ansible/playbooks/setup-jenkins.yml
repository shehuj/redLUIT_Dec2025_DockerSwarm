---
# ========================================
# Deploy Jenkins CI/CD Stack
# ========================================
- name: Deploy Jenkins CI/CD Stack
  hosts: swarm_manager
  become: true
  gather_facts: true

  vars:
    jenkins_home: /var/jenkins_home
    jenkins_port: 8081
    jenkins_agent_port: 50000
    min_memory_mb: 1024
    min_disk_gib: 3.0

  tasks:

    # ========================================
    # Basic Swarm Validation
    # ========================================
    - name: Verify Docker Swarm is active
      ansible.builtin.command: docker info --format '{{ "{{" }}.Swarm.LocalNodeState{{ "}}" }}'
      register: swarm_state
      changed_when: false
      failed_when: swarm_state.stdout != 'active'

    - name: Debug Swarm status
      ansible.builtin.debug:
        msg: "‚úî Docker Swarm is active!"

    # ========================================
    # Clean Up Existing Jenkins Services
    # ========================================
    - name: Find existing Jenkins services
      ansible.builtin.command: docker service ls --filter name=jenkins --format '{{ "{{" }}.Name{{ "}}" }}'
      register: existing_jenkins
      changed_when: false
      failed_when: false

    - name: Remove Jenkins stack if present
      ansible.builtin.command: docker stack rm jenkins
      when: existing_jenkins.stdout_lines | length > 0

    - name: Wait until Jenkins services are removed
      ansible.builtin.wait_for:
        path: /dev/null
        timeout: 30
      when: existing_jenkins.stdout_lines | length > 0

    # ----------------------------------------
    # Resource Validation
    # ========================================

    - name: Assert that memory facts exist
      ansible.builtin.assert:
        that:
          - ansible_facts['memtotal_mb'] is defined
        fail_msg: "Memory facts are not available. Cannot validate memory."
        success_msg: "Memory facts available."

    - name: Set available memory fact
      ansible.builtin.set_fact:
        available_memory_mb: "{{ ansible_facts['memfree_mb'] | int }}"

    - name: Ensure sufficient available memory
      ansible.builtin.assert:
        that:
          - available_memory_mb >= min_memory_mb
        fail_msg: "‚ùå Insufficient memory. Jenkins requires >= {{ min_memory_mb }}MB. Available: {{ available_memory_mb }}MB"
        success_msg: "‚úî Sufficient memory available: {{ available_memory_mb }}MB"

    - name: Check available disk space on Docker data directory
      ansible.builtin.shell: df -BG /var/lib/docker | tail -1 | awk '{print $4}' | sed 's/G//'
      register: docker_disk_space
      changed_when: false

    - name: Verify sufficient disk space for Jenkins
      ansible.builtin.assert:
        that:
          - docker_disk_space.stdout | float >= min_disk_gib
        fail_msg: "‚ùå Insufficient disk space. Jenkins requires at least {{ min_disk_gib }}GB. Available: {{ docker_disk_space.stdout }}GB"
        success_msg: "‚úî Sufficient disk space available: {{ docker_disk_space.stdout }}GB"

    # ========================================
    # Prepare Deployment Files
    # ========================================
    - name: Ensure deployment directory exists
      ansible.builtin.file:
        path: /opt/jenkins
        state: directory
        mode: '0755'

    - name: Copy Jenkins stack file
      ansible.builtin.copy:
        src: "../../jenkins-stack.yml"
        dest: /opt/jenkins/docker-compose.yml
        mode: '0644'
        backup: true

    # ----------------------------------------
    # Deploy Jenkins Stack
    # ========================================
    - name: Deploy Jenkins stack to Docker Swarm
      ansible.builtin.command:
        cmd: docker stack deploy -c docker-compose.yml jenkins
        chdir: /opt/jenkins
      register: jenkins_deploy
      changed_when: "'Creating service' in jenkins_deploy.stdout or 'Updating service' in jenkins_deploy.stdout"

    - name: Debug deployment output
      ansible.builtin.debug:
        var: jenkins_deploy.stdout_lines

    # ========================================
    # Wait for Jenkins Services
    # ========================================
    - name: Wait for Jenkins service to appear
      ansible.builtin.wait_for:
        timeout: 60
        state: started

    - name: Verify Jenkins replicas running
      ansible.builtin.command: docker service ls --filter "name=jenkins_jenkins" --format '{{ "{{" }}.Replicas{{ "}}" }}'
      register: jenkins_replicas
      retries: 15
      delay: 5
      until: jenkins_replicas.stdout is search("^[1-9]/[1-9]")
      changed_when: false

    # ========================================
    # HTTP Check for Jenkins
    # ========================================
    - name: Wait until Jenkins HTTP endpoint responds
      ansible.builtin.uri:
        url: "http://localhost:{{ jenkins_port }}/login"
        status_code: [200, 403]
        timeout: 10
        follow_redirects: safe
      register: jenkins_http
      retries: 20
      delay: 10
      failed_when: false

    - name: Debug Jenkins HTTP result
      ansible.builtin.debug:
        msg: "Jenkins HTTP status: {{ jenkins_http.status | default('unreachable') }}"

    # ========================================
    # Collect Initial Admin Password
    # ========================================
    - name: Get Jenkins container ID
      ansible.builtin.command:
        cmd: docker ps -q -f name=jenkins_jenkins
      register: container_id
      changed_when: false
      failed_when: false

    - name: Retrieve initial admin password if available
      ansible.builtin.command:
        cmd: docker exec {{ container_id.stdout }} cat /var/jenkins_home/secrets/initialAdminPassword
      register: jenkins_admin_password
      when: container_id.stdout != ""
      changed_when: false
      failed_when: false

    # ========================================
    # Display Summary
    # ========================================
    - name: Display Jenkins deployment summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "‚úî Jenkins Deployment Complete!"
          - "-----------------------------------------"
          - "HTTP Status: {{ jenkins_http.status | default('unreachable') }}"
          - "Memory Available: {{ available_memory_mb }}MB"
          - "Disk Available: {{ docker_disk_space.stdout }}GB"
          - "Jenkins URL: http://{{ ansible_facts.default_ipv4.address }}:{{ jenkins_port }}"
          - "Agent Port: {{ jenkins_agent_port }}"
          - ""
          - "üîë Initial Admin Password:"
          - "{{ jenkins_admin_password.stdout | default('NOT AVAILABLE YET - Wait for Jenkins to fully start') }}"
          - ""
          - "Password saved to: /opt/jenkins/initial_admin_password.txt"
          - "========================================="
