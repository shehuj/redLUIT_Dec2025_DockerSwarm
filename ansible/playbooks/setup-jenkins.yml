---
# ========================================
# Deploy Jenkins CI/CD Stack
# ========================================
- name: Deploy Jenkins CI/CD Stack
  hosts: swarm_manager
  become: true
  gather_facts: true

  vars:
    jenkins_home: /var/jenkins_home
    jenkins_port: 8081
    jenkins_agent_port: 50000
    min_memory_mb: 1024
    min_disk_gib: 3.0

  tasks:
    # ----------------------------------------
    # Basic Swarm Validation
    # ----------------------------------------
    - name: Verify Docker Swarm is active
      ansible.builtin.command: docker info --format '{{ "{{" }}.Swarm.LocalNodeState{{ "}}" }}'
      register: swarm_state
      changed_when: false
      failed_when: swarm_state.stdout != 'active'

    - name: Debug Swarm status
      ansible.builtin.debug:
        msg: "✔ Docker Swarm is active!"

    # ----------------------------------------
    # Clean Up Existing Jenkins Services
    # ----------------------------------------
    - name: Find existing Jenkins services
      ansible.builtin.command: docker service ls --filter name=jenkins --format '{{ "{{" }}.Name{{ "}}" }}'
      register: existing_jenkins
      changed_when: false
      failed_when: false

    - name: Remove Jenkins stack if present
      ansible.builtin.command: docker stack rm jenkins
      when: existing_jenkins.stdout_lines | length > 0

    - name: Wait until Jenkins services are removed
      ansible.builtin.wait_for:
        path: /dev/null
        timeout: 30
      when: existing_jenkins.stdout_lines | length > 0

    # ----------------------------------------
    # Resource Validation
    # ----------------------------------------
    - name: Ensure sufficient available memory
      ansible.builtin.assert:
        that:
          - ansible_mem.free_mb >= min_memory_mb
        success_msg: "✔ Enough memory available ({{ ansible_mem.free_mb }}MB)"
        fail_msg: "❌ Insufficient memory ({{ ansible_mem.free_mb }}MB), at least {{ min_memory_mb }}MB is needed."

    - name: Determine free space on Docker data mount
      ansible.builtin.set_fact:
        docker_mount: "{{ ansible_mounts | selectattr('mount','equalto','/var/lib/docker') | first }}"

    - name: Check free disk space in GiB for Docker root
      ansible.builtin.set_fact:
        free_disk_gib: "{{ (docker_mount.size_available | float) / (1024 ** 3) }}"

    - name: Assert free disk space is sufficient
      ansible.builtin.assert:
        that:
          - free_disk_gib >= min_disk_gib
        success_msg: "✔ Disk space check passed ({{ free_disk_gib | round(2) }}GiB free)"
        fail_msg: "❌ Free disk space is low ({{ free_disk_gib | round(2) }}GiB). At least {{ min_disk_gib }}GiB is recommended."

    # ----------------------------------------
    # Deploy Stack Directory & Config
    # ----------------------------------------
    - name: Ensure deployment directory exists
      ansible.builtin.file:
        path: /opt/jenkins
        state: directory
        mode: '0755'

    - name: Copy Jenkins stack file
      ansible.builtin.copy:
        src: "../../jenkins-stack.yml"
        dest: /opt/jenkins/docker-compose.yml
        mode: '0644'
        backup: true

    # ----------------------------------------
    # Deploy Jenkins Stack
    # ----------------------------------------
    - name: Deploy Jenkins stack to Docker Swarm
      ansible.builtin.command:
        cmd: docker stack deploy -c docker-compose.yml jenkins
        chdir: /opt/jenkins
      register: jenkins_deploy
      changed_when: "'Creating service' in jenkins_deploy.stdout or 'Updating service' in jenkins_deploy.stdout"

    - name: Debug deployment output
      ansible.builtin.debug:
        var: jenkins_deploy.stdout_lines

    # ----------------------------------------
    # Wait for Jenkins Services
    # ----------------------------------------
    - name: Wait for Jenkins service to appear
      ansible.builtin.wait_for:
        timeout: 60
        state: started
      register: wait_for_jenkins

    - name: Verify Jenkins service running with replicas
      ansible.builtin.command: docker service ls --filter "name=jenkins_jenkins" --format '{{ "{{" }}.Replicas{{ "}}" }}'
      register: jenkins_replicas
      retries: 15
      delay: 5
      until: jenkins_replicas.stdout is search("*/")

    # ----------------------------------------
    # Check Jenkins HTTP Endpoint
    # ----------------------------------------
    - name: Wait until Jenkins HTTP endpoint responds
      ansible.builtin.uri:
        url: "http://localhost:{{ jenkins_port }}/login"
        status_code: [200, 403]
        timeout: 10
        follow_redirects: safe
      register: jenkins_http
      retries: 20
      delay: 10
      failed_when: false

    - name: Debug Jenkins HTTP result
      ansible.builtin.debug:
        msg: "Jenkins HTTP status: {{ jenkins_http.status | default('unreachable') }}"

    # ----------------------------------------
    # Collect Initial Admin Password
    # ----------------------------------------
    - name: Get Jenkins container ID
      ansible.builtin.command: docker ps -q -f name=jenkins_jenkins
      register: container_id
      changed_when: false

    - name: Retrieve initial admin password if available
      ansible.builtin.command: docker exec {{ container_id.stdout }} cat /var/jenkins_home/secrets/initialAdminPassword
      register: jenkins_admin_password
      when: container_id.stdout != ""
      changed_when: false
      failed_when: false

    # ----------------------------------------
    # Output Summary
    # ----------------------------------------
    - name: Display finish summary
      ansible.builtin.debug:
        msg:
          - "✔ Jenkins is deployed!"
          - "HTTP Status: {{ jenkins_http.status | default('unreachable') }}"
          - "Free memory (MB): {{ ansible_mem.free_mb }}"
          - "Free disk space (GiB): {{ free_disk_gib | round(2) }}"
          - "Initial Admin Password: {{ jenkins_admin_password.stdout | default('not yet available') }}"
          - "Access Jenkins at: http://{{ ansible_facts.default_ipv4.address }}:{{ jenkins_port }}"