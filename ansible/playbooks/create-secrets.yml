---
# Playbook to create Docker secrets securely
- name: Create Docker Secrets
  hosts: swarm_manager
  become: true

  vars_prompt:
    - name: api_secret_key
      prompt: "Enter API secret key (or press Enter for default)"
      private: true
      default: "change-me-in-production"

    - name: grafana_admin_password
      prompt: "Enter Grafana admin password (or press Enter for default)"
      private: true
      default: "change-me-in-production"

  tasks:
    - name: Check if API Secret Exists
      ansible.builtin.shell: docker secret ls | grep -q api_secret_key
      register: api_secret_exists
      failed_when: false
      changed_when: false

    - name: Remove Old API Secret if Exists
      ansible.builtin.command: docker secret rm api_secret_key
      when: api_secret_exists.rc == 0
      failed_when: false

    - name: Create API Secret
      ansible.builtin.shell: |
        echo "{{ api_secret_key }}" | docker secret create api_secret_key -
      no_log: true
      changed_when: true

    - name: Check if Grafana Secret Exists
      ansible.builtin.shell: docker secret ls | grep -q grafana_admin_password
      register: grafana_secret_exists
      failed_when: false
      changed_when: false

    - name: Remove Old Grafana Secret if Exists
      ansible.builtin.command: docker secret rm grafana_admin_password
      when: grafana_secret_exists.rc == 0
      failed_when: false

    - name: Create Grafana Admin Password Secret
      ansible.builtin.shell: |
        echo "{{ grafana_admin_password }}" | docker secret create grafana_admin_password -
      no_log: true
      changed_when: true

    - name: List All Docker Secrets
      ansible.builtin.command: docker secret ls
      register: secret_list
      changed_when: false

    - name: Display Created Secrets
      ansible.builtin.debug:
        msg:
          - "✅ Secrets created successfully:"
          - "{{ secret_list.stdout_lines }}"
          - ""
          - "⚠️  Remember to update these secrets in production!"
