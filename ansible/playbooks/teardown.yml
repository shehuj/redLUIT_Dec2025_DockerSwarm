---
# Playbook to safely tear down the Docker Swarm cluster
- name: Teardown Docker Swarm Cluster
  hosts: swarm_manager
  become: true

  tasks:
    - name: Remove Docker Stack
      ansible.builtin.command: docker stack rm mystack
      failed_when: false
      changed_when: true

    - name: Wait for Stack to be Removed
      ansible.builtin.command: docker stack ls
      register: stack_list
      until: "'mystack' not in stack_list.stdout"
      retries: 30
      delay: 5
      changed_when: false
      failed_when: false

    - name: Remove Docker Secrets
      ansible.builtin.command: "docker secret rm {{ item }}"
      loop:
        - api_secret_key
        - grafana_admin_password
      failed_when: false
      changed_when: false

    - name: Display Manager Status
      ansible.builtin.debug:
        msg: "Stack removed from manager node"

- name: Leave Swarm on Worker Nodes
  hosts: swarm_workers
  become: true

  tasks:
    - name: Force Leave Swarm
      ansible.builtin.command: docker swarm leave --force
      failed_when: false
      changed_when: true

    - name: Display Worker Status
      ansible.builtin.debug:
        msg: "Worker node left swarm"

- name: Leave Swarm on Manager
  hosts: swarm_manager
  become: true

  tasks:
    - name: Force Leave Swarm (Manager)
      ansible.builtin.command: docker swarm leave --force
      failed_when: false
      changed_when: true

    - name: Display Teardown Complete
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "   âœ… Swarm Cluster Teardown Complete"
          - "========================================="
          - "All nodes have left the swarm"
          - "Docker is still installed and running"
          - "To remove Docker, run: ansible-playbook playbooks/uninstall-docker.yml"
