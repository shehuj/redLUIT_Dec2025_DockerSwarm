---
- name: Initialize Docker Swarm manager
  hosts: swarm_manager
  become: true
  tasks:
    - name: Check if Swarm is already initialized
      command: docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: swarm_status
      changed_when: false
      failed_when: false

    - name: Get private IP address
      set_fact:
        private_ip: "{{ ansible_default_ipv4.address }}"

    - name: Initialize Swarm on manager
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ private_ip }}"
      when: swarm_status.stdout != "active"
      register: swarm_init

    - name: Wait for Swarm to be ready
      command: docker node ls
      register: node_check
      until: node_check.rc == 0
      retries: 5
      delay: 2
      changed_when: false
      when: swarm_init is changed

    - name: Get Swarm info
      community.docker.docker_swarm_info:
      register: swarm_info

    - name: Set worker join token
      set_fact:
        worker_join_token: "{{ swarm_info.swarm_facts.JoinTokens.Worker }}"
        manager_addr: "{{ private_ip }}"

    - name: Set manager join token
      set_fact:
        manager_join_token: "{{ swarm_info.swarm_facts.JoinTokens.Manager }}"

    - name: Display Swarm status
      debug:
        msg:
          - "Swarm initialized successfully"
          - "Manager advertise address: {{ private_ip }}"
          - "Swarm ID: {{ swarm_info.swarm_facts.ID }}"

- name: Join workers to the Swarm
  hosts: swarm_workers
  become: true
  tasks:
    - name: Check if already part of Swarm
      command: docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: worker_swarm_status
      changed_when: false
      failed_when: false

    - name: Leave Swarm if in incorrect state
      command: docker swarm leave --force
      when:
        - worker_swarm_status.stdout == "active"
        - worker_swarm_status.stdout is defined
      ignore_errors: yes

    - name: Join worker to Swarm cluster
      community.docker.docker_swarm:
        state: join
        advertise_addr: "{{ ansible_default_ipv4.address }}"
        join_token: "{{ hostvars[groups['swarm_manager'][0]]['worker_join_token'] }}"
        remote_addrs:
          - "{{ hostvars[groups['swarm_manager'][0]]['manager_addr'] }}:2377"
      when: worker_swarm_status.stdout != "active"
      register: worker_join
      retries: 3
      delay: 5
      until: worker_join is succeeded

- name: Verify Swarm cluster
  hosts: swarm_manager
  become: true
  tasks:
    - name: Get node list
      command: docker node ls --format "{{ '{{' }}.Hostname{{ '}}' }} {{ '{{' }}.Status{{ '}}' }} {{ '{{' }}.ManagerStatus{{ '}}' }}"
      register: node_list
      changed_when: false

    - name: Display cluster nodes
      debug:
        msg: "{{ node_list.stdout_lines }}"

    - name: Verify expected number of nodes
      assert:
        that:
          - node_list.stdout_lines | length >= 2
        fail_msg: "Expected at least 2 nodes in the cluster"
        success_msg: "Swarm cluster has {{ node_list.stdout_lines | length }} nodes"

    - name: Label worker nodes for app deployment
      command: docker node update --label-add type=worker {{ item }}
      loop: "{{ groups['swarm_workers'] }}"
      when: groups['swarm_workers'] is defined
      changed_when: false
