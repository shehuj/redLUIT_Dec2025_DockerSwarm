---
- name: Initialize Docker Swarm Manager
  hosts: swarm_manager
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:

    - name: Install pip3 on remote host
      ansible.builtin.apt:
        name: python3-pip
        state: present
        update_cache: true

    - name: Ensure Docker SDK for Python Is Installed
      ansible.builtin.pip:
        name: docker
        executable: pip3
        state: present
        break_system_packages: true

    - name: Check If Swarm Is Already Initialized
      ansible.builtin.command: >
        docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: swarm_status
      changed_when: false
      failed_when: false

    - name: Set Manager Private IP Address
      ansible.builtin.set_fact:
        private_ip: "{{ ansible_facts.default_ipv4.address }}"

    - name: Initialize Swarm on Manager Node
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ private_ip }}"
      when: swarm_status.stdout != "active"
      register: swarm_init

    - name: Wait Until Manager Node Is Ready
      ansible.builtin.command: docker node ls
      register: node_check
      until: node_check.rc == 0
      retries: 5
      delay: 2
      when: swarm_init is changed
      changed_when: false

    - name: Fetch Swarm Information
      community.docker.docker_swarm_info:
      register: swarm_info

    - name: Set Worker Join Token
      ansible.builtin.set_fact:
        worker_join_token: "{{ swarm_info.swarm_facts.JoinTokens.Worker }}"
        manager_addr: "{{ private_ip }}"

    - name: Set Manager Join Token
      ansible.builtin.set_fact:
        manager_join_token: "{{ swarm_info.swarm_facts.JoinTokens.Manager }}"

    - name: Show Swarm Manager Status
      ansible.builtin.debug:
        msg:
          - "Swarm initialized"
          - "Manager advertise address: {{ private_ip }}"
          - "Worker join token: {{ worker_join_token }}"
          - "Manager join token: {{ manager_join_token }}"

- name: Join Worker Nodes to Swarm
  hosts: swarm_workers
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:

    - name: Install pip3 on remote host
      ansible.builtin.apt:
        name: python3-pip
        state: present
        update_cache: true

    - name: Ensure Docker SDK for Python Is Installed on Worker
      ansible.builtin.pip:
        name: docker
        executable: pip3
        state: present
        break_system_packages: true

    - name: Check If Worker Is Already Part of Swarm
      ansible.builtin.command: >
        docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: worker_swarm_status
      changed_when: false
      failed_when: false

    - name: Force Leave Swarm if Already Active
      ansible.builtin.command: docker swarm leave --force
      when: worker_swarm_status.stdout == "active"
      register: leave_result
      failed_when: false

    - name: Wait for Swarm Leave to Complete
      ansible.builtin.pause:
        seconds: 5
      when: worker_swarm_status.stdout == "active"

    - name: Verify Worker Left Swarm Successfully
      ansible.builtin.command: >
        docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: post_leave_status
      until: post_leave_status.stdout == "inactive"
      retries: 3
      delay: 2
      changed_when: false
      when: worker_swarm_status.stdout == "active"

    - name: Retrieve Worker Join Token from Manager
      community.docker.docker_swarm_info:
      delegate_to: "{{ groups['swarm_manager'][0] }}"
      run_once: true
      register: token_info

    - name: Set Worker Token Variables Locally
      ansible.builtin.set_fact:
        worker_join_token: "{{ token_info.swarm_facts.JoinTokens.Worker }}"
        manager_addr: "{{ hostvars[groups['swarm_manager'][0]]['ansible_facts']['default_ipv4']['address'] }}"

    - name: Verify Network Connectivity to Manager on Port 2377
      ansible.builtin.wait_for:
        host: "{{ manager_addr }}"
        port: 2377
        timeout: 30
        state: started

    - name: Re-check Swarm Status Before Join
      ansible.builtin.command: >
        docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: current_swarm_status
      changed_when: false

    - name: Force Leave if Still in Swarm After Previous Checks
      ansible.builtin.command: docker swarm leave --force
      when: current_swarm_status.stdout == "active"
      register: final_leave
      failed_when: false

    - name: Brief Wait After Final Leave
      ansible.builtin.pause:
        seconds: 3
      when: current_swarm_status.stdout == "active"

    - name: Join Worker to Swarm Cluster
      community.docker.docker_swarm:
        state: join
        advertise_addr: "{{ ansible_facts.default_ipv4.address }}"
        join_token: "{{ worker_join_token }}"
        remote_addrs:
          - "{{ manager_addr }}:2377"
        timeout: 60
      register: swarm_join_result
      retries: 3
      delay: 10
      until: swarm_join_result is succeeded

    - name: Verify Worker Successfully Joined Swarm
      ansible.builtin.command: >
        docker info --format "{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}"
      register: final_swarm_status
      until: final_swarm_status.stdout == "active"
      retries: 5
      delay: 3
      changed_when: false

- name: Verify Swarm Cluster
  hosts: swarm_manager
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Retrieve Node List
      ansible.builtin.command: >
        docker node ls --format "{{ '{{' }}.Hostname{{ '}}' }} {{ '{{' }}.Status{{ '}}' }} {{ '{{' }}.ManagerStatus{{ '}}' }}"
      register: node_list
      changed_when: false

    - name: Output Swarm Cluster Nodes
      ansible.builtin.debug:
        msg: "{{ node_list.stdout_lines }}"

    - name: Assert Minimum Swarm Nodes Present
      ansible.builtin.assert:
        that: node_list.stdout_lines | length >= 2
        fail_msg: "Expected at least 2 nodes in the cluster"
        success_msg: "Swarm cluster has {{ node_list.stdout_lines | length }} nodes"

    - name: Label Worker Nodes for Application Deployment
      ansible.builtin.command: >
        docker node update --label-add type=worker {{ item }}
      loop: "{{ groups['swarm_workers'] }}"
      when: groups['swarm_workers'] is defined
      changed_when: false