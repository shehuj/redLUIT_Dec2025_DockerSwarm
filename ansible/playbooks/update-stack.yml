---
# Playbook to update existing stack with zero downtime
- name: Update Docker Stack (Rolling Update)
  hosts: swarm_manager
  become: true

  tasks:
    - name: Check if Stack Exists
      ansible.builtin.command: docker stack ls
      register: stack_list
      changed_when: false

    - name: Fail if Stack Not Deployed
      ansible.builtin.fail:
        msg: "Stack 'mystack' is not deployed. Run deploy-stack.yml first."
      when: "'mystack' not in stack_list.stdout"

    - name: Copy Updated Stack File
      ansible.builtin.copy:
        src: "../../docker-stack.yml"
        dest: /tmp/docker-stack.yml
        mode: '0644'

    - name: Copy Updated Config Files
      ansible.builtin.copy:
        src: "../../configs/"
        dest: /tmp/configs/
        mode: '0644'

    - name: Update Docker Stack (Rolling)
      ansible.builtin.command: >
        docker stack deploy
        --compose-file /tmp/docker-stack.yml
        --with-registry-auth
        --prune
        mystack
      register: stack_update
      changed_when: "'Updating' in stack_update.stdout"

    - name: Wait for Services to Update
      ansible.builtin.command: >
        docker service ls
        --filter label=com.docker.stack.namespace=mystack
        --format "{{ '{{' }}.Name{{ '}}' }} {{ '{{' }}.Replicas{{ '}}' }}"
      register: service_status
      until: service_status.stdout_lines | select('search', '0/') | list | length == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Display Update Status
      ansible.builtin.debug:
        msg:
          - "✅ Stack updated successfully!"
          - "{{ service_status.stdout_lines }}"

    - name: Check for Failed Services
      ansible.builtin.shell: |
        docker stack ps mystack --no-trunc --format "{{ '{{' }}.Name{{ '}}' }} {{ '{{' }}.CurrentState{{ '}}' }}" | grep -i "failed" || true
      register: failed_services
      changed_when: false

    - name: Display Failed Services (if any)
      ansible.builtin.debug:
        msg:
          - "⚠️  Failed services detected:"
          - "{{ failed_services.stdout_lines }}"
      when: failed_services.stdout | length > 0

    - name: Display Success Message
      ansible.builtin.debug:
        msg: "✅ No failed services detected"
      when: failed_services.stdout | length == 0
