---
# Master playbook for complete Docker Swarm deployment
- name: Complete Docker Swarm Deployment
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display Deployment Start
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "   Docker Swarm Deployment Starting"
          - "========================================="
          - "This will:"
          - "  1. Install Docker on all nodes"
          - "  2. Initialize Docker Swarm"
          - "  3. Deploy application stack"
          - "  4. Verify deployment"
          - "========================================="

# Phase 1: Install Docker on all nodes
- name: Phase 1 - Install Docker
  ansible.builtin.import_playbook: playbooks/install-docker.yml

# Phase 2: Setup Docker Swarm
- name: Phase 2 - Initialize Swarm
  ansible.builtin.import_playbook: playbooks/swarm-setup.yml

# Phase 3: Setup Exporters on Swarm Nodes
- name: Phase 3 - Setup Exporters
  ansible.builtin.import_playbook: playbooks/setup-exporters.yml

# Phase 4: Setup Monitoring Server (Optional)
- name: Phase 4 - Setup Monitoring Server
  ansible.builtin.import_playbook: playbooks/setup-monitoring.yml
  when: setup_monitoring | default(false)

# Phase 5: Verify Exporters
- name: Phase 5 - Verify Exporters
  ansible.builtin.import_playbook: playbooks/test-exporters.yml

# Final Summary
- name: Deployment Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display Deployment Complete
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "   ✅ Docker Swarm Setup Complete!"
          - "========================================="
          - ""
          - "Swarm Cluster:"
          - "  • Manager: {{ hostvars[groups['swarm_manager'][0]]['ansible_host'] }}"
          - "  • Workers: {{ groups['swarm_workers'] | length }} nodes"
          - ""
          - "Metrics Exporters (on all nodes):"
          - "  • Node Exporter:  Port 9100"
          - "  • cAdvisor:       Port 8080"
          - "  • Docker Metrics: Port 9323"
          - ""
          - "{% if setup_monitoring | default(false) %}Monitoring Server:{% endif %}"
          - "{% if setup_monitoring | default(false) %}  • Prometheus: http://{{ hostvars[groups['monitoring'][0]]['ansible_host'] }}:9090{% endif %}"
          - "{% if setup_monitoring | default(false) %}  • Grafana:    http://{{ hostvars[groups['monitoring'][0]]['ansible_host'] }}:3000{% endif %}"
          - "{% if setup_monitoring | default(false) %}  • Credentials: admin / change-me-in-production{% endif %}"
          - "{% if not setup_monitoring | default(false) %}{% endif %}"
          - "{% if not setup_monitoring | default(false) %}To setup monitoring server:{% endif %}"
          - "{% if not setup_monitoring | default(false) %}  ansible-playbook site.yml -e 'setup_monitoring=true'{% endif %}"
          - ""
          - "========================================="
