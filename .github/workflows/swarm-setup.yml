name: Docker Swarm Setup

# Builds Docker Swarm cluster and validates worker nodes and labels
# Manual trigger only - infrastructure provisioning

on:
  workflow_dispatch:
    inputs:
      skip_docker_install:
        description: 'Skip Docker installation (if already installed)'
        required: false
        default: false
        type: boolean
      skip_validation:
        description: 'Skip validation checks'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: swarm-setup
  cancel-in-progress: false

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  SWARM_MANAGER_IP: ${{ secrets.SWARM_MANAGER_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  # ----------------------------------------
  # Install Docker
  # ----------------------------------------
  install-docker:
    name: Install Docker on All Nodes
    runs-on: ubuntu-latest
    if: inputs.skip_docker_install == false

    steps:
      - name: Verify Required Secrets
        run: |
          if [ -z "$SWARM_MANAGER_IP" ]; then
            echo "❌ Missing SWARM_MANAGER_IP secret"
            exit 1
          fi
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "❌ Missing SSH_PRIVATE_KEY secret"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP "echo 'SSH OK'"

      - name: Install Ansible and dependencies
        run: |
          pip install ansible boto3 botocore
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Install Docker on all nodes
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/install-docker.yml

      - name: Verify Docker installation
        run: |
          ansible all -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            -m command -a "docker --version"

  # ----------------------------------------
  # Initialize Swarm
  # ----------------------------------------
  initialize-swarm:
    name: Initialize Docker Swarm Cluster
    runs-on: ubuntu-latest
    needs: install-docker
    if: |
      always() &&
      (needs.install-docker.result == 'success' || needs.install-docker.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible and dependencies
        run: |
          pip install ansible boto3 botocore
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Initialize Swarm and join workers
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/swarm-setup.yml

  # ----------------------------------------
  # Validate Swarm
  # ----------------------------------------
  validate-swarm:
    name: Validate Swarm Cluster
    runs-on: ubuntu-latest
    needs: initialize-swarm
    if: |
      always() &&
      needs.initialize-swarm.result == 'success' &&
      inputs.skip_validation == false

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: pip install ansible

      - name: Validate worker nodes
        run: |
          ansible swarm_manager -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            -m command -a "docker node ls"

      - name: Check worker node count
        run: |
          WORKER_COUNT=$(ansible swarm_manager -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            -m command -a "docker node ls --filter role=worker --format '{{.ID}}'" | grep -c "^")
          echo "Worker nodes found: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 1 ]; then
            echo "❌ No worker nodes found"
            exit 1
          fi

      - name: Verify node labels
        run: |
          ansible swarm_manager -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            -m command -a "docker node ls --format '{{.Hostname}} {{.ManagerStatus}} {{.Availability}}'"

      - name: Check node labels exist
        run: |
          LABELED_WORKERS=$(ansible swarm_manager -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            -m shell -a "docker node inspect \$(docker node ls --filter role=worker --format '{{.ID}}') --format '{{.Spec.Labels}}'" | grep -c "type:worker" || echo "0")
          echo "Workers with type=worker label: $LABELED_WORKERS"

  # ----------------------------------------
  # Deploy Exporters
  # ----------------------------------------
  deploy-exporters:
    name: Deploy Metrics Exporters
    runs-on: ubuntu-latest
    needs: validate-swarm
    if: |
      always() &&
      (needs.validate-swarm.result == 'success' || needs.validate-swarm.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible and dependencies
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Deploy exporters on all nodes
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/setup-exporters.yml

  # ----------------------------------------
  # Verify Exporters
  # ----------------------------------------
  verify-exporters:
    name: Verify Metrics Exporters
    runs-on: ubuntu-latest
    needs: deploy-exporters
    if: |
      always() &&
      needs.deploy-exporters.result == 'success' &&
      inputs.skip_validation == false

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: pip install ansible

      - name: Verify exporters on all nodes
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/test-exporters.yml

      - name: Test exporter endpoints from manager
        run: |
          echo "Testing Docker metrics endpoint..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "curl -f http://localhost:9323/metrics" > /dev/null && echo "✅ Docker metrics OK"

          echo "Testing Node Exporter endpoint..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "curl -f http://localhost:9100/metrics" > /dev/null && echo "✅ Node Exporter OK"

          echo "Testing cAdvisor endpoint..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "curl -f http://localhost:8080/metrics" > /dev/null && echo "✅ cAdvisor OK"

  # ----------------------------------------
  # Summary
  # ----------------------------------------
  summary:
    name: Setup Summary
    runs-on: ubuntu-latest
    needs: [install-docker, initialize-swarm, validate-swarm, deploy-exporters, verify-exporters]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "### Docker Swarm Setup Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Installation: ${{ needs.install-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Swarm Initialization: ${{ needs.initialize-swarm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Swarm Validation: ${{ needs.validate-swarm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Exporters Deployment: ${{ needs.deploy-exporters.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Exporters Verification: ${{ needs.verify-exporters.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Swarm Manager IP: \`${{ secrets.SWARM_MANAGER_IP }}\`" >> $GITHUB_STEP_SUMMARY
