name: Docker Swarm Setup

# CI/CD Flow:
# - Push to dev: Dry run (validation only)
# - Merge to main: Actual deployment
# - Manual: workflow_dispatch

on:
  push:
    branches: ["dev", "main"]
    paths:
      - 'ansible/playbooks/install-docker.yml'
      - 'ansible/playbooks/swarm-setup.yml'
      - 'ansible/playbooks/setup-exporters.yml'
      - 'ansible/playbooks/test-exporters.yml'
      - 'ansible/inventory.yml'
      - '.github/workflows/swarm-setup.yml'

  workflow_dispatch:
    inputs:
      skip_docker_install:
        description: 'Skip Docker installation (if already installed)'
        required: false
        default: false
        type: boolean
      skip_validation:
        description: 'Skip validation checks'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: swarm-setup-${{ github.ref }}
  cancel-in-progress: true

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  SWARM_MANAGER_IP: ${{ secrets.SWARM_MANAGER_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  # ----------------------------------------
  # Install Docker
  # ----------------------------------------
  install-docker:
    name: Install Docker on All Nodes
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/dev') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.skip_docker_install == false)

    steps:
      - name: Verify Required Secrets
        run: |
          if [ -z "$SWARM_MANAGER_IP" ]; then
            echo "âŒ Missing SWARM_MANAGER_IP secret"
            exit 1
          fi
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ Missing SSH_PRIVATE_KEY secret"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP "echo 'SSH OK'"

      - name: Install Ansible and dependencies
        run: |
          pip install ansible boto3 botocore
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Install Docker on all nodes (Dry Run)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "ðŸ” Running in check mode (no actual changes)..."
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/install-docker.yml || true
          echo "âœ… Dry run complete"

      - name: Install Docker on all nodes (Actual)
        if: github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/install-docker.yml

      - name: Verify Docker installation
        if: github.ref == 'refs/heads/main'
        run: |
          ansible all -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            -m command -a "docker --version"

  # ----------------------------------------
  # Initialize Swarm
  # ----------------------------------------
  initialize-swarm:
    name: Initialize Docker Swarm Cluster
    runs-on: ubuntu-latest
    needs: install-docker
    if: |
      always() &&
      (needs.install-docker.result == 'success' || needs.install-docker.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible and dependencies
        run: |
          pip install ansible boto3 botocore
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Initialize Swarm and join workers (Dry Run)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "ðŸ” Running in check mode (no actual changes)..."
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/swarm-setup.yml || true
          echo "âœ… Dry run complete"

      - name: Initialize Swarm and join workers (Actual)
        if: github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/swarm-setup.yml

  # ----------------------------------------
  # Validate Swarm
  # ----------------------------------------
  validate-swarm:
    name: Validate Swarm Cluster
    runs-on: ubuntu-latest
    needs: initialize-swarm
    if: |
      always() &&
      needs.initialize-swarm.result == 'success' &&
      github.ref == 'refs/heads/main' &&
      (github.event_name != 'workflow_dispatch' || inputs.skip_validation == false)

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: pip install ansible

      - name: Validate worker nodes
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "docker node ls"

      - name: Check worker node count
        run: |
          WORKER_COUNT=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "docker node ls --filter role=worker --format '{{.ID}}'" | wc -l)
          echo "Worker nodes found: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 1 ]; then
            echo "âŒ No worker nodes found"
            exit 1
          fi

      - name: Verify node labels
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "docker node ls --format '{{.Hostname}} {{.ManagerStatus}} {{.Availability}}'"

      - name: Check node labels exist
        run: |
          LABELED_WORKERS=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "docker node inspect \$(docker node ls --filter role=worker --format '{{.ID}}') --format '{{.Spec.Labels}}'" | grep -c "type:worker" || echo "0")
          echo "Workers with type=worker label: $LABELED_WORKERS"

  # ----------------------------------------
  # Deploy Exporters
  # ----------------------------------------
  deploy-exporters:
    name: Deploy Metrics Exporters
    runs-on: ubuntu-latest
    needs: validate-swarm
    if: |
      always() &&
      (needs.validate-swarm.result == 'success' || needs.validate-swarm.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible and dependencies
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Deploy exporters on all nodes (Dry Run)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "ðŸ” Running in check mode (no actual changes)..."
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/setup-exporters.yml || true
          echo "âœ… Dry run complete"

      - name: Deploy exporters on all nodes (Actual)
        if: github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/setup-exporters.yml

  # ----------------------------------------
  # Verify Exporters
  # ----------------------------------------
  verify-exporters:
    name: Verify Metrics Exporters
    runs-on: ubuntu-latest
    needs: deploy-exporters
    if: |
      always() &&
      needs.deploy-exporters.result == 'success' &&
      github.ref == 'refs/heads/main' &&
      (github.event_name != 'workflow_dispatch' || inputs.skip_validation == false)

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: pip install ansible

      - name: Verify exporters on all nodes
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/test-exporters.yml

      - name: Test exporter endpoints from manager
        run: |
          echo "Testing Docker metrics endpoint..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "curl -f http://localhost:9323/metrics" > /dev/null && echo "âœ… Docker metrics OK"

          echo "Testing Node Exporter endpoint..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "curl -f http://localhost:9100/metrics" > /dev/null && echo "âœ… Node Exporter OK"

          echo "Testing cAdvisor endpoint..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP \
            "curl -f http://localhost:8080/metrics" > /dev/null && echo "âœ… cAdvisor OK"

  # ----------------------------------------
  # Summary
  # ----------------------------------------
  summary:
    name: Setup Summary
    runs-on: ubuntu-latest
    needs: [install-docker, initialize-swarm, validate-swarm, deploy-exporters, verify-exporters]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "### Docker Swarm Setup Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Installation: ${{ needs.install-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Swarm Initialization: ${{ needs.initialize-swarm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Swarm Validation: ${{ needs.validate-swarm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Exporters Deployment: ${{ needs.deploy-exporters.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Exporters Verification: ${{ needs.verify-exporters.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Swarm Manager IP: \`${{ secrets.SWARM_MANAGER_IP }}\`" >> $GITHUB_STEP_SUMMARY
