name: Docker Swarm CI/CD Pipeline

# Workflow Flow:
# 1. Any PR â†’ Run validations (lint, security, syntax) + Dry run deployment (check mode)
# 2. Merge to main â†’ Run validations + Actual deployment + Verification

on:
  # Run validations and dry run deployment on any pull request
  pull_request:
    paths:
      - 'ansible/**'
      - 'docker-stack.yml'
      - 'configs/**'
      - '.github/workflows/ansible-deploy.yml'

  # Run validations and actual deployment on merge to main branch
  push:
    branches: ["main"]
    paths:
      - 'ansible/**'
      - 'docker-stack.yml'
      - 'configs/**'
      - '.github/workflows/ansible-deploy.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  SWARM_MANAGER_IP: ${{ secrets.SWARM_MANAGER_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:

  # ----------------------------------------
  # Validate & Lint
  # ----------------------------------------
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.skip_tests == false)
    outputs:
      artifact-path: ${{ steps.artifact.outputs.artifact-path }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: |
          pip install --upgrade pip
          pip install ansible ansible-lint yamllint

      - name: Lint YAML
        run: yamllint -c .yamllint ansible/ docker-stack.yml configs/

      - name: Ansible Lint
        run: ansible-lint ansible/playbooks/

      - name: Save validation results
        run: |
          mkdir artifacts
          echo "Validation OK" > artifacts/validate.txt

      - name: Upload validation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}-${{ github.job }}
          path: artifacts

  # ----------------------------------------
  # Security Scanning
  # ----------------------------------------
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.skip_tests == false)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Trivy IaC Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: '.'

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save security results
        run: |
          mkdir artifacts
          echo "Security OK" > artifacts/security.txt

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}-${{ github.job }}
          path: artifacts
          # use the same name so multiple jobsâ€™ artifacts can be gathered

  # ----------------------------------------
  # Test Ansible
  # ----------------------------------------
  test:
    name: Test Ansible Playbooks (Syntax Check)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.skip_tests == false)
    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible collections
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Syntax check all playbooks
        run: |
          for playbook in ansible/playbooks/*.yml; do
            echo "Checking $playbook"
            ansible-playbook "$playbook" -i ansible/inventory.yml --syntax-check
          done

      - name: Save test results
        run: |
          mkdir artifacts
          echo "Tests OK" > artifacts/test.txt

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}
          path: artifacts

  # ----------------------------------------
  # Dry Run Deployment (Any PR)
  # ----------------------------------------
  dry-run:
    name: Dry Run Deployment
    runs-on: ubuntu-latest
    needs: [validate, security, test]
    if: github.event_name == 'pull_request'

    steps:
      - name: Download CI artifacts
        uses: actions/download-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}
          path: artifacts

      - name: Verify Required Secrets
        run: |
          if [ -z "$SWARM_MANAGER_IP" ]; then
            echo "âŒ Missing SWARM_MANAGER_IP"
            exit 1
          fi
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ Missing SSH_PRIVATE_KEY"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Write SSH private key
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP "echo 'SSH OK'"

      - name: Install Dependencies
        run: |
          pip install ansible boto3 botocore

      - name: Install Ansible Collections
        run: |
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Dry Run Deployment (Check Mode)
        run: |
          echo "ðŸ” Running deployment in check mode (no actual changes)..."
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/install-docker.yml || true
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/swarm-setup.yml || true
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/setup-exporters.yml || true
          echo "âœ… Dry run complete - no changes were made to the infrastructure"

  # ----------------------------------------
  # Deploy to Swarm (Merge to main)
  # ----------------------------------------
  deploy:
    name: Deploy to Docker Swarm
    runs-on: ubuntu-latest
    needs: [validate, security, test]
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Download CI artifacts
        uses: actions/download-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}
          path: artifacts

      - name: Verify Required Secrets
        run: |
          if [ -z "$SWARM_MANAGER_IP" ]; then
            echo "âŒ Missing SWARM_MANAGER_IP"
            exit 1
          fi
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ Missing SSH_PRIVATE_KEY"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Write SSH private key
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$SWARM_MANAGER_IP "echo 'SSH OK'"

      - name: Install Dependencies
        run: |
          pip install ansible boto3 botocore

      - name: Install Ansible Collections
        run: |
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Deploy via Ansible
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/install-docker.yml
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/swarm-setup.yml
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/setup-exporters.yml

  # ----------------------------------------
  # Verify Exporters
  # ----------------------------------------
  verify:
    name: Verify Exporters
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Wait for Exporters to Be Ready
        run: sleep 30

      - name: Verify Docker Metrics
        run: |
          for i in {1..5}; do
            if curl -f http://${{ env.SWARM_MANAGER_IP }}:9323/metrics; then
              echo "Docker metrics endpoint is accessible"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          exit 1

      - name: Verify Node Exporter
        run: |
          for i in {1..5}; do
            if curl -f http://${{ env.SWARM_MANAGER_IP }}:9100/metrics; then
              echo "Node Exporter is accessible"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          exit 1

      - name: Verify cAdvisor
        run: |
          for i in {1..5}; do
            if curl -f http://${{ env.SWARM_MANAGER_IP }}:8080/metrics; then
              echo "cAdvisor is accessible"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          exit 1