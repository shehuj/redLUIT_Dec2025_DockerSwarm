name: Docker Swarm CI/CD Pipeline

on:
  pull_request:
    branches: ["main", "dev"]
    paths:
      - 'ansible/**'
      - 'docker-stack.yml'
      - 'configs/**'
      - '.github/workflows/ansible-deploy.yml'

  push:
    branches: ["main", "dev"]
    paths:
      - 'ansible/**'
      - 'docker-stack.yml'
      - 'configs/**'
      - '.github/workflows/ansible-deploy.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  SWARM_MANAGER_IP: ${{ secrets.SWARM_MANAGER_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:

  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests == false }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: |
          pip install --upgrade pip
          pip install ansible ansible-lint yamllint

      - name: Lint YAML
        run: yamllint -c .yamllint ansible/ docker-stack.yml configs/

      - name: Ansible Lint
        run: ansible-lint ansible/playbooks/

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.skip_tests == false }}

    steps:
      - uses: actions/checkout@v4

      - name: Trivy IaC Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: '.'

security:
  name: Security Scanning
  runs-on: ubuntu-latest
  needs: validate
  if: ${{ inputs.skip_tests == false }}

  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Trivy IaC Scan
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: config
        scan-ref: '.'

    - name: Gitleaks Scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test Ansible Playbooks (Syntax Check)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: ${{ inputs.skip_tests == false }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible collections
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Syntax check all playbooks
        run: |
          for playbook in ansible/playbooks/*.yml; do
            echo "✓ Checking syntax: $playbook"
            ansible-playbook "$playbook" -i ansible/inventory.yml --syntax-check
          done

  deploy:
    name: Deploy to Docker Swarm
    runs-on: ubuntu-latest
    needs: [validate, security, test]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    environment:
      name: ${{ inputs.environment }}

    steps:

      - name: Verify Required Secrets
        run: |
          if [ -z "$SWARM_MANAGER_IP" ]; then
            echo "❌ Missing secret SWARM_MANAGER_IP"
            exit 1
          fi

          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "❌ Missing secret SSH_PRIVATE_KEY"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Start ssh-agent and add the key
          eval "$(ssh-agent -s)"
          printf "%s\n" "$SSH_PRIVATE_KEY" | ssh-add -

          # Add host to known_hosts
          ssh-keyscan -H "$SWARM_MANAGER_IP" >> ~/.ssh/known_hosts

      - name: Install Dependencies
        run: |
          pip install ansible boto3 botocore

      - name: Deploy via Ansible
        run: |
          ansible-playbook ansible/playbooks/install-docker.yml -i ansible/inventory.yml
          ansible-playbook ansible/playbooks/swarm-setup.yml -i ansible/inventory.yml
          ansible-playbook ansible/playbooks/deploy-stack.yml -i ansible/inventory.yml

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    steps:
      - run: curl -f http://${{ env.SWARM_MANAGER_IP }}/health
      - run: curl -f http://${{ env.SWARM_MANAGER_IP }}:9090/-/healthy
      - run: curl -f http://${{ env.SWARM_MANAGER_IP }}:3000/api/health
      - run: curl -f http://${{ env.SWARM_MANAGER_IP }}:6379/ping