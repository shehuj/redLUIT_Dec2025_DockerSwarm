name: Docker Swarm CI/CD Pipeline

on:
  pull_request:
    branches: ["main"]
    paths:
      - 'ansible/**'
      - 'docker-stack.yml'
      - 'configs/**'
      - '.github/workflows/ansible-deploy.yml'

  push:
    branches: ["main", "dev"]
    paths:
      - 'ansible/**'
      - 'docker-stack.yml'
      - 'configs/**'
      - '.github/workflows/ansible-deploy.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'

jobs:

  # 1. Validate & Lint
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests == false }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - run: |
          pip install --upgrade pip
          pip install ansible ansible-lint yamllint molecule

      - name: Install Ansible Galaxy collections
        working-directory: ansible
        run: ansible-galaxy collection install -r requirements.yml

      - run: yamllint -c .yamllint ansible/ docker-stack.yml configs/

      - name: Ansible Lint
        working-directory: ansible
        run: ansible-lint playbooks/

      - name: Ansible Syntax Check
        working-directory: ansible
        run: |
          for playbook in playbooks/*.yml; do
            ansible-playbook --syntax-check "$playbook" -i inventory.yml
          done

      - name: Docker Stack config test
        run: docker compose -f docker-stack.yml config

  # 2. Security Scan
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests == false }}
    needs: validate

    steps:
      - uses: actions/checkout@v4

      - name: Trivy IaC Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          format: sarif
          output: trivy-iac-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload SARIF findings
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-iac-results.sarif

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - run: |
          grep -R "password.*=.*['\"].*['\"]" ansible/ || true
          grep -R "secret.*=.*['\"].*['\"]" ansible/ || true

  # 3. Dry-Run Test
  test:
    name: Test Playbooks (Dry Run)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: ${{ inputs.skip_tests == false }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install ansible

      - name: Run Ansible in check mode
        working-directory: ansible
        run: |
          ansible-playbook playbooks/install-docker.yml -i inventory.yml --check --diff
          ansible-playbook playbooks/swarm-setup.yml -i inventory.yml --check --diff
          ansible-playbook playbooks/deploy-stack.yml -i inventory.yml --check --diff

  # 4. Deploy
  deploy:
    name: Deploy to Docker Swarm
    runs-on: ubuntu-latest
    needs: [validate, security, test]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      inputs.skip_tests == false
    environment:
      name: ${{ inputs.environment }}
      url: http://${{ secrets.SWARM_MANAGER_IP }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install ansible boto3 botocore

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.SWARM_MANAGER_IP }} >> ~/.ssh/known_hosts

      - name: Ansible Deploy
        working-directory: ansible
        run: |
          ansible-playbook playbooks/install-docker.yml -i inventory.yml
          ansible-playbook playbooks/swarm-setup.yml -i inventory.yml
          ansible-playbook playbooks/deploy-stack.yml -i inventory.yml

  # 5. Post-deployment Verify
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - run: curl -f http://${{ secrets.SWARM_MANAGER_IP }}/health

      - run: curl -f http://${{ secrets.SWARM_MANAGER_IP }}:9090/-/healthy

      - run: curl -f http://${{ secrets.SWARM_MANAGER_IP }}:3000/api/health