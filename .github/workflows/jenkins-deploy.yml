name: Jenkins CI/CD Stack Deployment

# Deploys Jenkins CI/CD stack to Docker Swarm
# - Checks Docker Swarm is active
# - Deploys Jenkins stack

on:
  pull_request:
    paths:
      - 'ansible/playbooks/setup-jenkins.yml'
      - 'jenkins-stack.yml'
      - 'ansible/inventory.yml'
      - '.github/workflows/jenkins-deploy.yml'

  push:
    branches: ["main"]
    paths:
      - 'ansible/playbooks/setup-jenkins.yml'
      - 'jenkins-stack.yml'
      - 'ansible/inventory.yml'
      - '.github/workflows/jenkins-deploy.yml'

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: jenkins-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  # ----------------------------------------
  # Deploy Jenkins Stack
  # ----------------------------------------
  deploy-jenkins:
    name: Deploy Jenkins CI/CD Stack
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Deploy Jenkins via Ansible (Dry Run)
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ” Running in check mode (no actual changes)..."
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            --check \
            --diff \
            ansible/playbooks/setup-jenkins.yml || true
          echo "âœ… Dry run complete"

      - name: Deploy Jenkins via Ansible (Actual)
        if: github.event_name != 'pull_request'
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/setup-jenkins.yml

      - name: Wait for Jenkins to stabilize
        if: github.event_name != 'pull_request'
        run: sleep 45

  # ----------------------------------------
  # Validate Jenkins Deployment
  # ----------------------------------------
  validate-jenkins:
    name: Validate Jenkins Deployment
    runs-on: ubuntu-latest
    needs: deploy-jenkins
    if: |
      always() &&
      needs.deploy-jenkins.result == 'success' &&
      github.event_name != 'pull_request'

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Check Jenkins service status
        run: |
          echo "Checking Jenkins service..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ls --filter 'name=jenkins' --format '{{.Name}} {{.Replicas}}'"

      - name: Verify Jenkins is accessible
        run: |
          echo "Testing Jenkins accessibility..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "curl -f http://localhost:8081/login" && echo "âœ… Jenkins is accessible" || \
            (echo "âŒ Jenkins is not accessible" && exit 1)

      - name: Get Jenkins initial admin password
        id: jenkins_pwd
        run: |
          echo "Retrieving Jenkins initial admin password..."
          PASSWORD=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            'docker exec $(docker ps -q -f name=jenkins_jenkins) cat /var/jenkins_home/secrets/initialAdminPassword' 2>/dev/null || echo "N/A")
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "Password retrieved: ${PASSWORD:0:5}..." # Show first 5 chars only

      - name: Check Jenkins logs for errors
        run: |
          echo "Checking Jenkins logs..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service logs --tail 50 jenkins_jenkins" || true

      - name: Verify Jenkins service placement
        run: |
          echo "Jenkins service placement:"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ps jenkins_jenkins --format '{{.Node}} {{.CurrentState}}'"

  # ----------------------------------------
  # Display Access Information
  # ----------------------------------------
  access-info:
    name: Display Jenkins Access Information
    runs-on: ubuntu-latest
    needs: [deploy-jenkins, validate-jenkins]
    if: always()

    steps:
      - name: Generate access information
        run: |
          echo "### Jenkins CI/CD Stack Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Jenkins Deployment: ${{ needs.deploy-jenkins.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Jenkins Validation: ${{ needs.validate-jenkins.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-jenkins.result }}" == "success" ]; then
            echo "### ðŸš€ Jenkins Access URLs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Jenkins**: http://${{ secrets.MANAGER_IP }}:8081" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”‘ Initial Setup" >> $GITHUB_STEP_SUMMARY
            echo "1. SSH into manager: \`ssh ubuntu@${{ secrets.MANAGER_IP }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Get admin password: \`docker exec \$(docker ps -q -f name=jenkins) cat /var/jenkins_home/secrets/initialAdminPassword\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Access Jenkins and complete setup wizard" >> $GITHUB_STEP_SUMMARY
            echo "4. Install suggested plugins" >> $GITHUB_STEP_SUMMARY
            echo "5. Create your first admin user" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Deployed Services" >> $GITHUB_STEP_SUMMARY
            echo "- Jenkins Master (on manager node)" >> $GITHUB_STEP_SUMMARY
            echo "- Jenkins Agents (on all worker nodes)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  # ----------------------------------------
  # Comprehensive Stack Health Check
  # ----------------------------------------
  final-health-check:
    name: Final Stack Health Check
    runs-on: ubuntu-latest
    needs: [deploy-jenkins, validate-jenkins]
    if: always() && needs.deploy-jenkins.result == 'success'

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Check all running stacks
        run: |
          echo "========================================="
          echo "All Docker Stacks:"
          echo "========================================="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker stack ls"

      - name: Check all services across cluster
        run: |
          echo "========================================="
          echo "All Services in Cluster:"
          echo "========================================="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ls"

      - name: Final health summary
        run: |
          echo "### ðŸ¥ Final Cluster Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker node ls" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Jenkins deployment complete!" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All infrastructure validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CI/CD pipeline ready for use" >> $GITHUB_STEP_SUMMARY
