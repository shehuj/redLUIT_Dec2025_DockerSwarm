name: Jenkins CI/CD Stack Deployment

# Deploys the Jenkins CI/CD stack to Docker Swarm ONLY on merge to main
on:
  push:
    branches: ["main"]
    paths:
      - 'ansible/playbooks/setup-jenkins.yml'
      - 'jenkins-stack.yml'
      - 'ansible/inventory.yml'
      - '.github/workflows/jenkins-deploy.yml'

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: jenkins-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  # ----------------------------------------
  # Deploy Jenkins Stack
  # ----------------------------------------
  deploy-jenkins:
    name: Deploy Jenkins CI/CD Stack
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.MANAGER_IP }} >> ~/.ssh/known_hosts

      - name: Install Ansible & Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Deploy Jenkins with Ansible
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/setup-jenkins.yml

      - name: Wait for Jenkins to start
        run: sleep 45

  # ----------------------------------------
  # Validate Jenkins Deployment
  # ----------------------------------------
  validate-jenkins:
    name: Validate Jenkins Deployment
    runs-on: ubuntu-latest
    needs: deploy-jenkins
    if: needs.deploy-jenkins.result == 'success'

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.MANAGER_IP }} >> ~/.ssh/known_hosts

      - name: Check Jenkins service status
        run: |
          echo "Checking Jenkins service..."
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ls --filter name=jenkins --format '{{.Name}} {{.Replicas}}'"

      - name: Verify Jenkins accessibility
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "curl -f http://localhost:8081/login" && echo "âœ… Jenkins accessible" || exit 1

      - name: Retrieve Jenkins initial admin password
        id: jenkins_pwd
        run: |
          PASSWORD=$(ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            'docker exec $(docker ps -q -f name=jenkins_jenkins) \
            cat /var/jenkins_home/secrets/initialAdminPassword' 2>/dev/null || echo "N/A")
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "Partial password: ${PASSWORD:0:6}..."

      - name: Check Jenkins logs for errors
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service logs --tail 50 jenkins_jenkins" || true

      - name: Verify Jenkins service placement
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ps jenkins_jenkins --format '{{.Node}} {{.CurrentState}}'"

  # ----------------------------------------
  # Display Access Information
  # ----------------------------------------
  access-info:
    name: Display Jenkins Access Information
    runs-on: ubuntu-latest
    needs: [deploy-jenkins, validate-jenkins]
    if: always()

    steps:
      - name: Write access info to summary
        run: |
          echo "### Jenkins CI/CD Stack Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment: ${{ needs.deploy-jenkins.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate-jenkins.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-jenkins.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Access Jenkins" >> $GITHUB_STEP_SUMMARY
            echo "- URL: http://${{ secrets.MANAGER_IP }}:8081" >> $GITHUB_STEP_SUMMARY
            echo "- Initial admin password stored in outputs" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi

  # ----------------------------------------
  # Health Check Summary
  # ----------------------------------------
  final-health-check:
    name: Final Stack Health Check
    runs-on: ubuntu-latest
    needs: validate-jenkins
    if: needs.deploy-jenkins.result == 'success'

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.MANAGER_IP }} >> ~/.ssh/known_hosts

      - name: Check Docker stacks
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} "docker stack ls"

      - name: Check all cluster services
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} "docker service ls"

      - name: Add health summary
        run: |
          echo "### ðŸ©º Cluster Health Summary" >> $GITHUB_STEP_SUMMARY
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} "docker node ls" >> $GITHUB_STEP_SUMMARY