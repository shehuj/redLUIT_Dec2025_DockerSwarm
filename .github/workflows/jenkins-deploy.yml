name: Jenkins CI/CD Stack Deployment

# Deploys Jenkins CI/CD stack to Docker Swarm
# IMPORTANT: Only deploys after all other infrastructure is ready
# - Validates Swarm cluster health
# - Validates exporters are running
# - Validates monitoring stack is deployed
# - Then deploys Jenkins

on:
  workflow_run:
    workflows:
      - "Docker Swarm Cluster Setup"
      - "Deploy Exporters"
      - "Monitoring Stack Deployment"
    types:
      - completed
    branches: [main]

  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip prerequisite validation checks'
        required: false
        default: false
        type: boolean
      force_deploy:
        description: 'Force deploy even if other workflows failed'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: jenkins-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  # ----------------------------------------
  # Validate Prerequisites
  # ----------------------------------------
  validate-prerequisites:
    name: Validate All Prerequisites
    runs-on: ubuntu-latest
    # Only run if triggered workflows succeeded OR force_deploy is true
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.force_deploy == true) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}

    steps:
      - name: Check workflow_run trigger status
        if: github.event_name == 'workflow_run'
        run: |
          echo "Triggered by: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ Prerequisite workflow did not succeed"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Validate Swarm cluster health
        id: validate
        run: |
          echo "Validating Docker Swarm cluster..."

          # Check if manager is accessible
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker info --format '{{.Swarm.LocalNodeState}}'" | grep -q "active"

          if [ $? -eq 0 ]; then
            echo "âœ… Swarm is active"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Swarm is not active"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify all nodes are ready
        run: |
          echo "Checking swarm nodes status..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            'docker node ls --format "{{.Hostname}} {{.Status}} {{.Availability}}"'

          # Check for Down or Drain nodes
          DOWN_NODES=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            'docker node ls --format "{{.Status}}"' | grep -c "Down" || true)

          if [ "$DOWN_NODES" -gt 0 ]; then
            echo "âŒ Found $DOWN_NODES nodes that are Down"
            exit 1
          fi
          echo "âœ… All nodes are Ready"

      - name: Check exporters are running
        if: inputs.skip_validation != true
        run: |
          echo "Validating exporters on manager..."

          # Check Docker Metrics
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "curl -f http://localhost:9323/metrics" > /dev/null && echo "âœ… Docker Metrics OK" || (echo "âŒ Docker Metrics failed" && exit 1)

          # Check Node Exporter
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "curl -f http://localhost:9100/metrics" > /dev/null && echo "âœ… Node Exporter OK" || (echo "âŒ Node Exporter failed" && exit 1)

          # Check cAdvisor
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "curl -f http://localhost:8080/metrics" > /dev/null && echo "âœ… cAdvisor OK" || (echo "âŒ cAdvisor failed" && exit 1)

      - name: Validation summary
        run: |
          echo "### Prerequisites Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker Swarm cluster is active" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All nodes are ready" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Exporters are running" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready to deploy Jenkins!" >> $GITHUB_STEP_SUMMARY

  # ----------------------------------------
  # Deploy Jenkins Stack
  # ----------------------------------------
  deploy-jenkins:
    name: Deploy Jenkins CI/CD Stack
    runs-on: ubuntu-latest
    needs: validate-prerequisites
    if: needs.validate-prerequisites.outputs.validation_passed == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Deploy Jenkins via Ansible
        run: |
          ansible-playbook -i ansible/inventory.yml \
            --private-key ~/.ssh/id_rsa \
            ansible/playbooks/setup-jenkins.yml

      - name: Wait for Jenkins to stabilize
        run: sleep 45

  # ----------------------------------------
  # Validate Jenkins Deployment
  # ----------------------------------------
  validate-jenkins:
    name: Validate Jenkins Deployment
    runs-on: ubuntu-latest
    needs: deploy-jenkins
    if: always() && needs.deploy-jenkins.result == 'success'

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Check Jenkins service status
        run: |
          echo "Checking Jenkins service..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ls --filter 'name=jenkins' --format '{{.Name}} {{.Replicas}}'"

      - name: Verify Jenkins is accessible
        run: |
          echo "Testing Jenkins accessibility..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "curl -f http://localhost:8080/login" && echo "âœ… Jenkins is accessible" || \
            (echo "âŒ Jenkins is not accessible" && exit 1)

      - name: Get Jenkins initial admin password
        id: jenkins_pwd
        run: |
          echo "Retrieving Jenkins initial admin password..."
          PASSWORD=$(ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            'docker exec $(docker ps -q -f name=jenkins_jenkins) cat /var/jenkins_home/secrets/initialAdminPassword' 2>/dev/null || echo "N/A")
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "Password retrieved: ${PASSWORD:0:5}..." # Show first 5 chars only

      - name: Check Jenkins logs for errors
        run: |
          echo "Checking Jenkins logs..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service logs --tail 50 jenkins_jenkins" || true

      - name: Verify Jenkins service placement
        run: |
          echo "Jenkins service placement:"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ps jenkins_jenkins --format '{{.Node}} {{.CurrentState}}'"

  # ----------------------------------------
  # Display Access Information
  # ----------------------------------------
  access-info:
    name: Display Jenkins Access Information
    runs-on: ubuntu-latest
    needs: [deploy-jenkins, validate-jenkins]
    if: always()

    steps:
      - name: Generate access information
        run: |
          echo "### Jenkins CI/CD Stack Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Prerequisites Validation: ${{ needs.validate-prerequisites.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Jenkins Deployment: ${{ needs.deploy-jenkins.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Jenkins Validation: ${{ needs.validate-jenkins.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-jenkins.result }}" == "success" ]; then
            echo "### ðŸš€ Jenkins Access URLs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Jenkins**: http://${{ secrets.MANAGER_IP }}:8080" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”‘ Initial Setup" >> $GITHUB_STEP_SUMMARY
            echo "1. SSH into manager: \`ssh ubuntu@${{ secrets.MANAGER_IP }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Get admin password: \`docker exec \$(docker ps -q -f name=jenkins) cat /var/jenkins_home/secrets/initialAdminPassword\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Access Jenkins and complete setup wizard" >> $GITHUB_STEP_SUMMARY
            echo "4. Install suggested plugins" >> $GITHUB_STEP_SUMMARY
            echo "5. Create your first admin user" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Deployed Services" >> $GITHUB_STEP_SUMMARY
            echo "- Jenkins Master (on manager node)" >> $GITHUB_STEP_SUMMARY
            echo "- Jenkins Agents (on all worker nodes)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
          fi

  # ----------------------------------------
  # Comprehensive Stack Health Check
  # ----------------------------------------
  final-health-check:
    name: Final Stack Health Check
    runs-on: ubuntu-latest
    needs: [deploy-jenkins, validate-jenkins]
    if: always() && needs.deploy-jenkins.result == 'success'

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Check all running stacks
        run: |
          echo "========================================="
          echo "All Docker Stacks:"
          echo "========================================="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker stack ls"

      - name: Check all services across cluster
        run: |
          echo "========================================="
          echo "All Services in Cluster:"
          echo "========================================="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker service ls"

      - name: Final health summary
        run: |
          echo "### ðŸ¥ Final Cluster Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.MANAGER_IP }} \
            "docker node ls" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Jenkins deployment complete!" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All infrastructure validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CI/CD pipeline ready for use" >> $GITHUB_STEP_SUMMARY
